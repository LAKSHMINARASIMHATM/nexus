{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg';\r\nimport * as dotenv from 'dotenv';\r\n\r\ndotenv.config({ path: '.env.local' });\r\ndotenv.config({ path: '.env' });\r\n\r\nconsole.log('Initializing DB pool with:', process.env.DATABASE_URL);\r\n\r\nconst pool = new Pool({\r\n    connectionString: process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/search_engine',\r\n    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\r\n});\r\n\r\nexport default pool;\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEA,iJAAa,CAAC;IAAE,MAAM;AAAa;AACnC,iJAAa,CAAC;IAAE,MAAM;AAAO;AAE7B,QAAQ,GAAG,CAAC,8BAA8B,QAAQ,GAAG,CAAC,YAAY;AAElE,MAAM,OAAO,IAAI,4GAAI,CAAC;IAClB,kBAAkB,QAAQ,GAAG,CAAC,YAAY,IAAI;IAC9C,KAAK,sCAAwC,0BAAgC;AACjF;uCAEe"}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/lib/services/interaction-service.ts"],"sourcesContent":["import pool from '../db';\r\n\r\nexport interface SearchEvent {\r\n    user_id?: string;\r\n    session_id: string;\r\n    query: string;\r\n    result_count: number;\r\n    execution_time_ms: number;\r\n}\r\n\r\nexport interface ClickEvent {\r\n    search_event_id: string;\r\n    doc_id: string;\r\n    position: number;\r\n    user_id?: string;\r\n    session_id: string;\r\n}\r\n\r\nexport class InteractionService {\r\n    async logSearchEvent(event: SearchEvent): Promise<string> {\r\n        const sql = `\r\n            INSERT INTO search_events (\r\n                user_id, \r\n                session_id, \r\n                query_text, \r\n                result_count, \r\n                execution_time_ms\r\n            )\r\n            VALUES ($1, $2, $3, $4, $5)\r\n            RETURNING event_id\r\n        `;\r\n\r\n        try {\r\n            const result = await pool.query(sql, [\r\n                event.user_id || null,\r\n                event.session_id,\r\n                event.query,\r\n                event.result_count,\r\n                event.execution_time_ms\r\n            ]);\r\n            return result.rows[0].event_id;\r\n        } catch (error) {\r\n            console.error('Failed to log search event:', error);\r\n            return ''; // Fail gracefully\r\n        }\r\n    }\r\n\r\n    async logClickEvent(event: ClickEvent): Promise<string> {\r\n        const sql = `\r\n            INSERT INTO click_events (\r\n                search_event_id,\r\n                doc_id,\r\n                position\r\n            )\r\n            VALUES ($1, $2, $3)\r\n            RETURNING click_id\r\n        `;\r\n\r\n        try {\r\n            // Verify search_event_id exists to maintain referential integrity\r\n            // In a real high-volume system, we might skip this check or use a queue\r\n            if (event.search_event_id) {\r\n                const result = await pool.query(sql, [\r\n                    event.search_event_id,\r\n                    event.doc_id,\r\n                    event.position\r\n                ]);\r\n                return result.rows[0].click_id;\r\n            } else {\r\n                console.warn('Click event missing search_event_id, skipping insert');\r\n                return '';\r\n            }\r\n        } catch (error) {\r\n            console.error('Failed to log click event:', error);\r\n            return '';\r\n        }\r\n    }\r\n\r\n    async getUserHistory(userId: string, limit: number = 10) {\r\n        const sql = `\r\n            SELECT \r\n                se.query_text, \r\n                se.timestamp, \r\n                count(ce.click_id) as clicks\r\n            FROM search_events se\r\n            LEFT JOIN click_events ce ON se.event_id = ce.search_event_id\r\n            WHERE se.user_id = $1\r\n            GROUP BY se.event_id, se.query_text, se.timestamp\r\n            ORDER BY se.timestamp DESC\r\n            LIMIT $2\r\n        `;\r\n\r\n        try {\r\n            const result = await pool.query(sql, [userId, limit]);\r\n            return result.rows;\r\n        } catch (error) {\r\n            console.error('Failed to get user history:', error);\r\n            return [];\r\n        }\r\n    }\r\n}\r\n\r\nexport const interactionService = new InteractionService();\r\n"],"names":[],"mappings":";;;;;;AAAA;;;;;;AAkBO,MAAM;IACT,MAAM,eAAe,KAAkB,EAAmB;QACtD,MAAM,MAAM,CAAC;;;;;;;;;;QAUb,CAAC;QAED,IAAI;YACA,MAAM,SAAS,MAAM,sHAAI,CAAC,KAAK,CAAC,KAAK;gBACjC,MAAM,OAAO,IAAI;gBACjB,MAAM,UAAU;gBAChB,MAAM,KAAK;gBACX,MAAM,YAAY;gBAClB,MAAM,iBAAiB;aAC1B;YACD,OAAO,OAAO,IAAI,CAAC,EAAE,CAAC,QAAQ;QAClC,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,OAAO,IAAI,kBAAkB;QACjC;IACJ;IAEA,MAAM,cAAc,KAAiB,EAAmB;QACpD,MAAM,MAAM,CAAC;;;;;;;;QAQb,CAAC;QAED,IAAI;YACA,kEAAkE;YAClE,wEAAwE;YACxE,IAAI,MAAM,eAAe,EAAE;gBACvB,MAAM,SAAS,MAAM,sHAAI,CAAC,KAAK,CAAC,KAAK;oBACjC,MAAM,eAAe;oBACrB,MAAM,MAAM;oBACZ,MAAM,QAAQ;iBACjB;gBACD,OAAO,OAAO,IAAI,CAAC,EAAE,CAAC,QAAQ;YAClC,OAAO;gBACH,QAAQ,IAAI,CAAC;gBACb,OAAO;YACX;QACJ,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,8BAA8B;YAC5C,OAAO;QACX;IACJ;IAEA,MAAM,eAAe,MAAc,EAAE,QAAgB,EAAE,EAAE;QACrD,MAAM,MAAM,CAAC;;;;;;;;;;;QAWb,CAAC;QAED,IAAI;YACA,MAAM,SAAS,MAAM,sHAAI,CAAC,KAAK,CAAC,KAAK;gBAAC;gBAAQ;aAAM;YACpD,OAAO,OAAO,IAAI;QACtB,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,OAAO,EAAE;QACb;IACJ;AACJ;AAEO,MAAM,qBAAqB,IAAI"}},
    {"offset": {"line": 208, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/app/api/v1/click/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { interactionService } from '@/lib/services/interaction-service';\r\n\r\nexport async function POST(req: NextRequest) {\r\n    try {\r\n        const body = await req.json();\r\n        const { search_event_id, doc_id, position } = body;\r\n        const sessionId = req.headers.get('x-session-id') || 'anonymous';\r\n        const userId = req.headers.get('x-user-id') || undefined;\r\n\r\n        if (!search_event_id || !doc_id) {\r\n            return NextResponse.json(\r\n                { error: 'Missing required fields: search_event_id, doc_id' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const clickId = await interactionService.logClickEvent({\r\n            search_event_id,\r\n            doc_id,\r\n            position: position || 0,\r\n            session_id: sessionId,\r\n            user_id: userId,\r\n        });\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            click_id: clickId,\r\n        });\r\n    } catch (error: any) {\r\n        console.error('Click API error:', error);\r\n        return NextResponse.json(\r\n            { error: 'Internal server error' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEO,eAAe,KAAK,GAAgB;IACvC,IAAI;QACA,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,eAAe,EAAE,MAAM,EAAE,QAAQ,EAAE,GAAG;QAC9C,MAAM,YAAY,IAAI,OAAO,CAAC,GAAG,CAAC,mBAAmB;QACrD,MAAM,SAAS,IAAI,OAAO,CAAC,GAAG,CAAC,gBAAgB;QAE/C,IAAI,CAAC,mBAAmB,CAAC,QAAQ;YAC7B,OAAO,gJAAY,CAAC,IAAI,CACpB;gBAAE,OAAO;YAAmD,GAC5D;gBAAE,QAAQ;YAAI;QAEtB;QAEA,MAAM,UAAU,MAAM,iKAAkB,CAAC,aAAa,CAAC;YACnD;YACA;YACA,UAAU,YAAY;YACtB,YAAY;YACZ,SAAS;QACb;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT,UAAU;QACd;IACJ,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,gJAAY,CAAC,IAAI,CACpB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}