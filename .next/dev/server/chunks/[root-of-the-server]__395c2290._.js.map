{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/lib/db.ts"],"sourcesContent":["import { Pool } from 'pg';\r\nimport * as dotenv from 'dotenv';\r\n\r\ndotenv.config({ path: '.env.local' });\r\ndotenv.config({ path: '.env' });\r\n\r\nconsole.log('Initializing DB pool with:', process.env.DATABASE_URL);\r\n\r\nconst pool = new Pool({\r\n    connectionString: process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/search_engine',\r\n    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\r\n});\r\n\r\nexport default pool;\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEA,iJAAa,CAAC;IAAE,MAAM;AAAa;AACnC,iJAAa,CAAC;IAAE,MAAM;AAAO;AAE7B,QAAQ,GAAG,CAAC,8BAA8B,QAAQ,GAAG,CAAC,YAAY;AAElE,MAAM,OAAO,IAAI,4GAAI,CAAC;IAClB,kBAAkB,QAAQ,GAAG,CAAC,YAAY,IAAI;IAC9C,KAAK,sCAAwC,0BAAgC;AACjF;uCAEe"}},
    {"offset": {"line": 107, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/lib/services/search-service.ts"],"sourcesContent":["import pool from '../db';\r\n\r\nexport interface SearchParams {\r\n    query: string;\r\n    page?: number;\r\n    pageSize?: number;\r\n    filters?: {\r\n        language?: string;\r\n        dateRange?: {\r\n            start: string;\r\n            end: string;\r\n        };\r\n        site?: string;\r\n    };\r\n}\r\n\r\nexport interface SearchResult {\r\n    doc_id: string;\r\n    url: string;\r\n    title: string;\r\n    snippet: string;\r\n    score: number;\r\n    highlights: string[];\r\n    metadata: {\r\n        author?: string;\r\n        published_date?: string;\r\n        language?: string;\r\n    };\r\n}\r\n\r\nexport interface SearchResponse {\r\n    query: {\r\n        original: string;\r\n        corrected?: string;\r\n        intent?: string;\r\n    };\r\n    results: SearchResult[];\r\n    total_results: number;\r\n    page: number;\r\n    page_size: number;\r\n    query_time_ms: number;\r\n    suggestions: string[];\r\n}\r\n\r\nexport class SearchService {\r\n    async search(params: SearchParams): Promise<SearchResponse> {\r\n        const startTime = Date.now();\r\n        const { query, page = 1, pageSize = 10 } = params;\r\n        const offset = (page - 1) * pageSize;\r\n\r\n        // PostgreSQL Full-Text Search\r\n        // We use websearch_to_tsquery for advanced syntax support (quotes, or, -negation)\r\n        // We search across title, meta_description, and body with different weights\r\n        const sql = `\r\n            WITH search_query AS (\r\n                SELECT websearch_to_tsquery('english', $1) as query\r\n            ),\r\n            ranked_docs AS (\r\n                SELECT \r\n                    doc_id,\r\n                    url,\r\n                    title,\r\n                    meta_description,\r\n                    body,\r\n                    pagerank,\r\n                    crawl_timestamp,\r\n                    language,\r\n                    -- Rank calculation: (Title A-weight) + (Meta B-weight) + (Body C-weight)\r\n                    ts_rank_cd(\r\n                        setweight(to_tsvector('english', title), 'A') ||\r\n                        setweight(to_tsvector('english', coalesce(meta_description, '')), 'B') ||\r\n                        setweight(to_tsvector('english', coalesce(body, '')), 'C'),\r\n                        (SELECT query FROM search_query)\r\n                    ) as rank\r\n                FROM documents\r\n                WHERE \r\n                    (\r\n                        setweight(to_tsvector('english', title), 'A') ||\r\n                        setweight(to_tsvector('english', coalesce(meta_description, '')), 'B') ||\r\n                        setweight(to_tsvector('english', coalesce(body, '')), 'C')\r\n                    ) @@ (SELECT query FROM search_query)\r\n            ),\r\n            total_count AS (\r\n                SELECT COUNT(*) as count FROM ranked_docs\r\n            )\r\n            SELECT \r\n                rd.*,\r\n                tc.count as total_results,\r\n                ts_headline('english', rd.body, (SELECT query FROM search_query), \r\n                    'StartSel=<em>, StopSel=</em>, MaxWords=35, MinWords=15, ShortWord=3, HighlightAll=FALSE, MaxFragments=1, FragmentDelimiter=\"...\"'\r\n                ) as body_highlight,\r\n                ts_headline('english', rd.title, (SELECT query FROM search_query), \r\n                    'StartSel=<em>, StopSel=</em>, HighlightAll=FALSE'\r\n                ) as title_highlight\r\n            FROM ranked_docs rd, total_count tc\r\n            ORDER BY rank DESC, pagerank DESC\r\n            LIMIT $2 OFFSET $3\r\n        `;\r\n\r\n        try {\r\n            console.log(`Executing SQL for query: \"${query}\"`);\r\n            const result = await pool.query(sql, [query, pageSize, offset]);\r\n            console.log(`SQL executed. Rows: ${result.rows.length}`);\r\n\r\n            const totalResults = result.rows.length > 0 ? parseInt(result.rows[0].total_results, 10) : 0;\r\n\r\n            const searchResults: SearchResult[] = result.rows.map((row: any) => ({\r\n                doc_id: row.doc_id,\r\n                url: row.url,\r\n                title: row.title,\r\n                snippet: row.body_highlight || row.meta_description || '',\r\n                score: row.rank,\r\n                highlights: [\r\n                    row.title_highlight,\r\n                    row.body_highlight\r\n                ].filter(Boolean),\r\n                metadata: {\r\n                    language: row.language,\r\n                    published_date: row.crawl_timestamp,\r\n                },\r\n            }));\r\n\r\n            const endTime = Date.now();\r\n\r\n            // Log the search event\r\n            this.logSearchEvent(query, totalResults, endTime - startTime);\r\n\r\n            return {\r\n                query: {\r\n                    original: query,\r\n                },\r\n                results: searchResults,\r\n                total_results: totalResults,\r\n                page,\r\n                page_size: pageSize,\r\n                query_time_ms: endTime - startTime,\r\n                suggestions: [],\r\n            };\r\n        } catch (error) {\r\n            console.error('Search error:', error);\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    private async logSearchEvent(query: string, resultCount: number, executionTime: number) {\r\n        try {\r\n            const sql = `\r\n                INSERT INTO search_events (query_text, result_count, execution_time_ms)\r\n                VALUES ($1, $2, $3)\r\n            `;\r\n            await pool.query(sql, [query, resultCount, executionTime]);\r\n        } catch (err) {\r\n            console.error('Failed to log search event:', err);\r\n        }\r\n    }\r\n\r\n    async suggest(query: string, limit: number = 10): Promise<string[]> {\r\n        const sql = `\r\n            SELECT query_text \r\n            FROM query_suggestions \r\n            WHERE query_text ILIKE $1 \r\n            ORDER BY frequency DESC \r\n            LIMIT $2\r\n        `;\r\n        try {\r\n            const result = await pool.query(sql, [`${query}%`, limit]);\r\n            return result.rows.map((row: any) => row.query_text);\r\n        } catch (error) {\r\n            console.error('Suggestion error:', error);\r\n            return [];\r\n        }\r\n    }\r\n}\r\n\r\nexport const searchService = new SearchService();\r\n"],"names":[],"mappings":";;;;;;AAAA;;;;;;AA4CO,MAAM;IACT,MAAM,OAAO,MAAoB,EAA2B;QACxD,MAAM,YAAY,KAAK,GAAG;QAC1B,MAAM,EAAE,KAAK,EAAE,OAAO,CAAC,EAAE,WAAW,EAAE,EAAE,GAAG;QAC3C,MAAM,SAAS,CAAC,OAAO,CAAC,IAAI;QAE5B,8BAA8B;QAC9B,kFAAkF;QAClF,4EAA4E;QAC5E,MAAM,MAAM,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;QA4Cb,CAAC;QAED,IAAI;YACA,QAAQ,GAAG,CAAC,CAAC,0BAA0B,EAAE,MAAM,CAAC,CAAC;YACjD,MAAM,SAAS,MAAM,sHAAI,CAAC,KAAK,CAAC,KAAK;gBAAC;gBAAO;gBAAU;aAAO;YAC9D,QAAQ,GAAG,CAAC,CAAC,oBAAoB,EAAE,OAAO,IAAI,CAAC,MAAM,EAAE;YAEvD,MAAM,eAAe,OAAO,IAAI,CAAC,MAAM,GAAG,IAAI,SAAS,OAAO,IAAI,CAAC,EAAE,CAAC,aAAa,EAAE,MAAM;YAE3F,MAAM,gBAAgC,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC,MAAa,CAAC;oBACjE,QAAQ,IAAI,MAAM;oBAClB,KAAK,IAAI,GAAG;oBACZ,OAAO,IAAI,KAAK;oBAChB,SAAS,IAAI,cAAc,IAAI,IAAI,gBAAgB,IAAI;oBACvD,OAAO,IAAI,IAAI;oBACf,YAAY;wBACR,IAAI,eAAe;wBACnB,IAAI,cAAc;qBACrB,CAAC,MAAM,CAAC;oBACT,UAAU;wBACN,UAAU,IAAI,QAAQ;wBACtB,gBAAgB,IAAI,eAAe;oBACvC;gBACJ,CAAC;YAED,MAAM,UAAU,KAAK,GAAG;YAExB,uBAAuB;YACvB,IAAI,CAAC,cAAc,CAAC,OAAO,cAAc,UAAU;YAEnD,OAAO;gBACH,OAAO;oBACH,UAAU;gBACd;gBACA,SAAS;gBACT,eAAe;gBACf;gBACA,WAAW;gBACX,eAAe,UAAU;gBACzB,aAAa,EAAE;YACnB;QACJ,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,iBAAiB;YAC/B,MAAM;QACV;IACJ;IAEA,MAAc,eAAe,KAAa,EAAE,WAAmB,EAAE,aAAqB,EAAE;QACpF,IAAI;YACA,MAAM,MAAM,CAAC;;;YAGb,CAAC;YACD,MAAM,sHAAI,CAAC,KAAK,CAAC,KAAK;gBAAC;gBAAO;gBAAa;aAAc;QAC7D,EAAE,OAAO,KAAK;YACV,QAAQ,KAAK,CAAC,+BAA+B;QACjD;IACJ;IAEA,MAAM,QAAQ,KAAa,EAAE,QAAgB,EAAE,EAAqB;QAChE,MAAM,MAAM,CAAC;;;;;;QAMb,CAAC;QACD,IAAI;YACA,MAAM,SAAS,MAAM,sHAAI,CAAC,KAAK,CAAC,KAAK;gBAAC,GAAG,MAAM,CAAC,CAAC;gBAAE;aAAM;YACzD,OAAO,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC,MAAa,IAAI,UAAU;QACvD,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,qBAAqB;YACnC,OAAO,EAAE;QACb;IACJ;AACJ;AAEO,MAAM,gBAAgB,IAAI"}},
    {"offset": {"line": 258, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/lib/services/interaction-service.ts"],"sourcesContent":["import pool from '../db';\r\n\r\nexport interface SearchEvent {\r\n    user_id?: string;\r\n    session_id: string;\r\n    query: string;\r\n    result_count: number;\r\n    execution_time_ms: number;\r\n}\r\n\r\nexport interface ClickEvent {\r\n    search_event_id: string;\r\n    doc_id: string;\r\n    position: number;\r\n    user_id?: string;\r\n    session_id: string;\r\n}\r\n\r\nexport class InteractionService {\r\n    async logSearchEvent(event: SearchEvent): Promise<string> {\r\n        const sql = `\r\n            INSERT INTO search_events (\r\n                user_id, \r\n                session_id, \r\n                query_text, \r\n                result_count, \r\n                execution_time_ms\r\n            )\r\n            VALUES ($1, $2, $3, $4, $5)\r\n            RETURNING event_id\r\n        `;\r\n\r\n        try {\r\n            const result = await pool.query(sql, [\r\n                event.user_id || null,\r\n                event.session_id,\r\n                event.query,\r\n                event.result_count,\r\n                event.execution_time_ms\r\n            ]);\r\n            return result.rows[0].event_id;\r\n        } catch (error) {\r\n            console.error('Failed to log search event:', error);\r\n            return ''; // Fail gracefully\r\n        }\r\n    }\r\n\r\n    async logClickEvent(event: ClickEvent): Promise<string> {\r\n        const sql = `\r\n            INSERT INTO click_events (\r\n                search_event_id,\r\n                doc_id,\r\n                position\r\n            )\r\n            VALUES ($1, $2, $3)\r\n            RETURNING click_id\r\n        `;\r\n\r\n        try {\r\n            // Verify search_event_id exists to maintain referential integrity\r\n            // In a real high-volume system, we might skip this check or use a queue\r\n            if (event.search_event_id) {\r\n                const result = await pool.query(sql, [\r\n                    event.search_event_id,\r\n                    event.doc_id,\r\n                    event.position\r\n                ]);\r\n                return result.rows[0].click_id;\r\n            } else {\r\n                console.warn('Click event missing search_event_id, skipping insert');\r\n                return '';\r\n            }\r\n        } catch (error) {\r\n            console.error('Failed to log click event:', error);\r\n            return '';\r\n        }\r\n    }\r\n\r\n    async getUserHistory(userId: string, limit: number = 10) {\r\n        const sql = `\r\n            SELECT \r\n                se.query_text, \r\n                se.timestamp, \r\n                count(ce.click_id) as clicks\r\n            FROM search_events se\r\n            LEFT JOIN click_events ce ON se.event_id = ce.search_event_id\r\n            WHERE se.user_id = $1\r\n            GROUP BY se.event_id, se.query_text, se.timestamp\r\n            ORDER BY se.timestamp DESC\r\n            LIMIT $2\r\n        `;\r\n\r\n        try {\r\n            const result = await pool.query(sql, [userId, limit]);\r\n            return result.rows;\r\n        } catch (error) {\r\n            console.error('Failed to get user history:', error);\r\n            return [];\r\n        }\r\n    }\r\n}\r\n\r\nexport const interactionService = new InteractionService();\r\n"],"names":[],"mappings":";;;;;;AAAA;;;;;;AAkBO,MAAM;IACT,MAAM,eAAe,KAAkB,EAAmB;QACtD,MAAM,MAAM,CAAC;;;;;;;;;;QAUb,CAAC;QAED,IAAI;YACA,MAAM,SAAS,MAAM,sHAAI,CAAC,KAAK,CAAC,KAAK;gBACjC,MAAM,OAAO,IAAI;gBACjB,MAAM,UAAU;gBAChB,MAAM,KAAK;gBACX,MAAM,YAAY;gBAClB,MAAM,iBAAiB;aAC1B;YACD,OAAO,OAAO,IAAI,CAAC,EAAE,CAAC,QAAQ;QAClC,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,OAAO,IAAI,kBAAkB;QACjC;IACJ;IAEA,MAAM,cAAc,KAAiB,EAAmB;QACpD,MAAM,MAAM,CAAC;;;;;;;;QAQb,CAAC;QAED,IAAI;YACA,kEAAkE;YAClE,wEAAwE;YACxE,IAAI,MAAM,eAAe,EAAE;gBACvB,MAAM,SAAS,MAAM,sHAAI,CAAC,KAAK,CAAC,KAAK;oBACjC,MAAM,eAAe;oBACrB,MAAM,MAAM;oBACZ,MAAM,QAAQ;iBACjB;gBACD,OAAO,OAAO,IAAI,CAAC,EAAE,CAAC,QAAQ;YAClC,OAAO;gBACH,QAAQ,IAAI,CAAC;gBACb,OAAO;YACX;QACJ,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,8BAA8B;YAC5C,OAAO;QACX;IACJ;IAEA,MAAM,eAAe,MAAc,EAAE,QAAgB,EAAE,EAAE;QACrD,MAAM,MAAM,CAAC;;;;;;;;;;;QAWb,CAAC;QAED,IAAI;YACA,MAAM,SAAS,MAAM,sHAAI,CAAC,KAAK,CAAC,KAAK;gBAAC;gBAAQ;aAAM;YACpD,OAAO,OAAO,IAAI;QACtB,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,OAAO,EAAE;QACb;IACJ;AACJ;AAEO,MAAM,qBAAqB,IAAI"}},
    {"offset": {"line": 411, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/lib/metrics/prometheus.ts"],"sourcesContent":["import { register, Counter, Histogram, Gauge } from 'prom-client';\r\n\r\n// Query metrics\r\nexport const queryCounter = new Counter({\r\n    name: 'search_queries_total',\r\n    help: 'Total number of search queries',\r\n    labelNames: ['status', 'cache_hit'],\r\n});\r\n\r\nexport const queryLatency = new Histogram({\r\n    name: 'search_query_duration_seconds',\r\n    help: 'Search query latency in seconds',\r\n    labelNames: ['stage'],\r\n    buckets: [0.01, 0.05, 0.1, 0.2, 0.5, 1, 2, 5],\r\n});\r\n\r\nexport const queryResultCount = new Histogram({\r\n    name: 'search_query_results',\r\n    help: 'Number of results returned per query',\r\n    buckets: [0, 1, 10, 100, 1000, 10000],\r\n});\r\n\r\n// Indexing metrics\r\nexport const indexingCounter = new Counter({\r\n    name: 'documents_indexed_total',\r\n    help: 'Total number of documents indexed',\r\n    labelNames: ['status'],\r\n});\r\n\r\nexport const indexingLatency = new Histogram({\r\n    name: 'indexing_duration_seconds',\r\n    help: 'Document indexing latency in seconds',\r\n    buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5],\r\n});\r\n\r\n// Crawler metrics\r\nexport const crawlCounter = new Counter({\r\n    name: 'urls_crawled_total',\r\n    help: 'Total number of URLs crawled',\r\n    labelNames: ['status'],\r\n});\r\n\r\nexport const crawlLatency = new Histogram({\r\n    name: 'crawl_duration_seconds',\r\n    help: 'URL crawl latency in seconds',\r\n    buckets: [0.1, 0.5, 1, 2, 5, 10, 30],\r\n});\r\n\r\nexport const crawlQueueSize = new Gauge({\r\n    name: 'crawl_queue_size',\r\n    help: 'Current size of the crawl queue',\r\n    labelNames: ['priority'],\r\n});\r\n\r\n// Cache metrics\r\nexport const cacheHitCounter = new Counter({\r\n    name: 'cache_hits_total',\r\n    help: 'Total number of cache hits',\r\n    labelNames: ['tier'],\r\n});\r\n\r\nexport const cacheMissCounter = new Counter({\r\n    name: 'cache_misses_total',\r\n    help: 'Total number of cache misses',\r\n    labelNames: ['tier'],\r\n});\r\n\r\n// System metrics\r\nexport const activeConnections = new Gauge({\r\n    name: 'active_connections',\r\n    help: 'Number of active connections',\r\n    labelNames: ['service'],\r\n});\r\n\r\nexport const errorCounter = new Counter({\r\n    name: 'errors_total',\r\n    help: 'Total number of errors',\r\n    labelNames: ['service', 'type'],\r\n});\r\n\r\n// Export metrics endpoint\r\nexport function getMetrics() {\r\n    return register.metrics();\r\n}\r\n\r\nexport { register };\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AAGO,MAAM,eAAe,IAAI,oJAAO,CAAC;IACpC,MAAM;IACN,MAAM;IACN,YAAY;QAAC;QAAU;KAAY;AACvC;AAEO,MAAM,eAAe,IAAI,sJAAS,CAAC;IACtC,MAAM;IACN,MAAM;IACN,YAAY;QAAC;KAAQ;IACrB,SAAS;QAAC;QAAM;QAAM;QAAK;QAAK;QAAK;QAAG;QAAG;KAAE;AACjD;AAEO,MAAM,mBAAmB,IAAI,sJAAS,CAAC;IAC1C,MAAM;IACN,MAAM;IACN,SAAS;QAAC;QAAG;QAAG;QAAI;QAAK;QAAM;KAAM;AACzC;AAGO,MAAM,kBAAkB,IAAI,oJAAO,CAAC;IACvC,MAAM;IACN,MAAM;IACN,YAAY;QAAC;KAAS;AAC1B;AAEO,MAAM,kBAAkB,IAAI,sJAAS,CAAC;IACzC,MAAM;IACN,MAAM;IACN,SAAS;QAAC;QAAM;QAAM;QAAK;QAAK;QAAG;QAAG;KAAE;AAC5C;AAGO,MAAM,eAAe,IAAI,oJAAO,CAAC;IACpC,MAAM;IACN,MAAM;IACN,YAAY;QAAC;KAAS;AAC1B;AAEO,MAAM,eAAe,IAAI,sJAAS,CAAC;IACtC,MAAM;IACN,MAAM;IACN,SAAS;QAAC;QAAK;QAAK;QAAG;QAAG;QAAG;QAAI;KAAG;AACxC;AAEO,MAAM,iBAAiB,IAAI,kJAAK,CAAC;IACpC,MAAM;IACN,MAAM;IACN,YAAY;QAAC;KAAW;AAC5B;AAGO,MAAM,kBAAkB,IAAI,oJAAO,CAAC;IACvC,MAAM;IACN,MAAM;IACN,YAAY;QAAC;KAAO;AACxB;AAEO,MAAM,mBAAmB,IAAI,oJAAO,CAAC;IACxC,MAAM;IACN,MAAM;IACN,YAAY;QAAC;KAAO;AACxB;AAGO,MAAM,oBAAoB,IAAI,kJAAK,CAAC;IACvC,MAAM;IACN,MAAM;IACN,YAAY;QAAC;KAAU;AAC3B;AAEO,MAAM,eAAe,IAAI,oJAAO,CAAC;IACpC,MAAM;IACN,MAAM;IACN,YAAY;QAAC;QAAW;KAAO;AACnC;AAGO,SAAS;IACZ,OAAO,qJAAQ,CAAC,OAAO;AAC3B"}},
    {"offset": {"line": 564, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/app/api/v1/search/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { searchService } from '@/lib/services/search-service';\r\nimport { interactionService } from '@/lib/services/interaction-service';\r\n// import { cacheService } from '@/lib/services/cache-service'; // Disabled for No-Docker\r\n// import { kafkaService } from '@/lib/services/kafka-service'; // Disabled for No-Docker\r\nimport { queryCounter, queryLatency, queryResultCount } from '@/lib/metrics/prometheus';\r\nimport crypto from 'crypto';\r\n\r\nexport async function POST(req: NextRequest) {\r\n    const startTime = Date.now();\r\n\r\n    try {\r\n        const body = await req.json();\r\n        const { query, page = 1, page_size = 10, filters, options } = body;\r\n\r\n        if (!query || typeof query !== 'string' || query.trim().length === 0) {\r\n            queryCounter.inc({ status: 'error', cache_hit: 'false' });\r\n            return NextResponse.json(\r\n                {\r\n                    error: {\r\n                        code: 'INVALID_QUERY',\r\n                        message: 'Query string is required',\r\n                        details: { field: 'query', constraint: 'non_empty' },\r\n                    },\r\n                    request_id: `req_${Date.now()}`,\r\n                },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Search with PostgreSQL (via SearchService)\r\n        const searchStart = Date.now();\r\n        const results = await searchService.search({\r\n            query,\r\n            page,\r\n            pageSize: page_size,\r\n            filters,\r\n        });\r\n        const executionTime = Date.now() - searchStart;\r\n        queryLatency.observe({ stage: 'postgres' }, executionTime / 1000);\r\n\r\n        // Log search event\r\n        const sessionId = req.headers.get('x-session-id') || 'anonymous';\r\n        const userId = req.headers.get('x-user-id') || undefined;\r\n\r\n        let eventId = '';\r\n        try {\r\n            eventId = await interactionService.logSearchEvent({\r\n                user_id: userId,\r\n                session_id: sessionId,\r\n                query,\r\n                result_count: results.total_results,\r\n                execution_time_ms: executionTime,\r\n            });\r\n        } catch (err) {\r\n            console.error('Error logging search event:', err);\r\n        }\r\n\r\n        // Record metrics\r\n        queryCounter.inc({ status: 'success', cache_hit: 'false' });\r\n        queryResultCount.observe(results.results.length);\r\n        queryLatency.observe({ stage: 'total' }, (Date.now() - startTime) / 1000);\r\n\r\n        return NextResponse.json({\r\n            ...results,\r\n            meta: {\r\n                search_event_id: eventId,\r\n                request_id: `req_${Date.now()}`,\r\n            }\r\n        });\r\n    } catch (error: any) {\r\n        console.error('Search API error:', error);\r\n        queryCounter.inc({ status: 'error', cache_hit: 'false' });\r\n\r\n        return NextResponse.json(\r\n            {\r\n                error: {\r\n                    code: 'INTERNAL_ERROR',\r\n                    message: 'An internal server error occurred',\r\n                    details: process.env.NODE_ENV === 'development' ? error.message : undefined,\r\n                },\r\n                request_id: `req_${Date.now()}`,\r\n            },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA,yFAAyF;AACzF,yFAAyF;AACzF;;;;;;;;;;AAGO,eAAe,KAAK,GAAgB;IACvC,MAAM,YAAY,KAAK,GAAG;IAE1B,IAAI;QACA,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,KAAK,EAAE,OAAO,CAAC,EAAE,YAAY,EAAE,EAAE,OAAO,EAAE,OAAO,EAAE,GAAG;QAE9D,IAAI,CAAC,SAAS,OAAO,UAAU,YAAY,MAAM,IAAI,GAAG,MAAM,KAAK,GAAG;YAClE,8JAAY,CAAC,GAAG,CAAC;gBAAE,QAAQ;gBAAS,WAAW;YAAQ;YACvD,OAAO,gJAAY,CAAC,IAAI,CACpB;gBACI,OAAO;oBACH,MAAM;oBACN,SAAS;oBACT,SAAS;wBAAE,OAAO;wBAAS,YAAY;oBAAY;gBACvD;gBACA,YAAY,CAAC,IAAI,EAAE,KAAK,GAAG,IAAI;YACnC,GACA;gBAAE,QAAQ;YAAI;QAEtB;QAEA,6CAA6C;QAC7C,MAAM,cAAc,KAAK,GAAG;QAC5B,MAAM,UAAU,MAAM,uJAAa,CAAC,MAAM,CAAC;YACvC;YACA;YACA,UAAU;YACV;QACJ;QACA,MAAM,gBAAgB,KAAK,GAAG,KAAK;QACnC,8JAAY,CAAC,OAAO,CAAC;YAAE,OAAO;QAAW,GAAG,gBAAgB;QAE5D,mBAAmB;QACnB,MAAM,YAAY,IAAI,OAAO,CAAC,GAAG,CAAC,mBAAmB;QACrD,MAAM,SAAS,IAAI,OAAO,CAAC,GAAG,CAAC,gBAAgB;QAE/C,IAAI,UAAU;QACd,IAAI;YACA,UAAU,MAAM,iKAAkB,CAAC,cAAc,CAAC;gBAC9C,SAAS;gBACT,YAAY;gBACZ;gBACA,cAAc,QAAQ,aAAa;gBACnC,mBAAmB;YACvB;QACJ,EAAE,OAAO,KAAK;YACV,QAAQ,KAAK,CAAC,+BAA+B;QACjD;QAEA,iBAAiB;QACjB,8JAAY,CAAC,GAAG,CAAC;YAAE,QAAQ;YAAW,WAAW;QAAQ;QACzD,kKAAgB,CAAC,OAAO,CAAC,QAAQ,OAAO,CAAC,MAAM;QAC/C,8JAAY,CAAC,OAAO,CAAC;YAAE,OAAO;QAAQ,GAAG,CAAC,KAAK,GAAG,KAAK,SAAS,IAAI;QAEpE,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,GAAG,OAAO;YACV,MAAM;gBACF,iBAAiB;gBACjB,YAAY,CAAC,IAAI,EAAE,KAAK,GAAG,IAAI;YACnC;QACJ;IACJ,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,qBAAqB;QACnC,8JAAY,CAAC,GAAG,CAAC;YAAE,QAAQ;YAAS,WAAW;QAAQ;QAEvD,OAAO,gJAAY,CAAC,IAAI,CACpB;YACI,OAAO;gBACH,MAAM;gBACN,SAAS;gBACT,SAAS,uCAAyC,MAAM,OAAO,GAAG;YACtE;YACA,YAAY,CAAC,IAAI,EAAE,KAAK,GAAG,IAAI;QACnC,GACA;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}