{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/lib/db.ts"],"sourcesContent":["import { Pool } from '@neondatabase/serverless';\r\nimport * as dotenv from 'dotenv';\r\n\r\ndotenv.config({ path: '.env.local' });\r\ndotenv.config({ path: '.env' });\r\n\r\nconsole.log('Initializing Neon DB pool...');\r\n\r\nconst pool = new Pool({\r\n    connectionString: process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/search_engine',\r\n    ssl: true,\r\n});\r\n\r\nexport default pool;\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,iJAAa,CAAC;IAAE,MAAM;AAAa;AACnC,iJAAa,CAAC;IAAE,MAAM;AAAO;AAE7B,QAAQ,GAAG,CAAC;AAEZ,MAAM,OAAO,IAAI,gKAAI,CAAC;IAClB,kBAAkB,QAAQ,GAAG,CAAC,YAAY,IAAI;IAC9C,KAAK;AACT;uCAEe"}},
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/lib/services/interaction-service.ts"],"sourcesContent":["import pool from '../db';\r\n\r\nexport interface SearchEvent {\r\n    user_id?: string;\r\n    session_id: string;\r\n    query: string;\r\n    result_count: number;\r\n    execution_time_ms: number;\r\n}\r\n\r\nexport interface ClickEvent {\r\n    search_event_id: string;\r\n    doc_id: string;\r\n    position: number;\r\n    user_id?: string;\r\n    session_id: string;\r\n}\r\n\r\nexport class InteractionService {\r\n    async logSearchEvent(event: SearchEvent): Promise<string> {\r\n        const sql = `\r\n            INSERT INTO search_events (\r\n                user_id, \r\n                session_id, \r\n                query_text, \r\n                result_count, \r\n                execution_time_ms\r\n            )\r\n            VALUES ($1, $2, $3, $4, $5)\r\n            RETURNING event_id\r\n        `;\r\n\r\n        try {\r\n            const result = await pool.query(sql, [\r\n                event.user_id || null,\r\n                event.session_id,\r\n                event.query,\r\n                event.result_count,\r\n                event.execution_time_ms\r\n            ]);\r\n            return result.rows[0].event_id;\r\n        } catch (error) {\r\n            console.error('Failed to log search event:', error);\r\n            return ''; // Fail gracefully\r\n        }\r\n    }\r\n\r\n    async logClickEvent(event: ClickEvent): Promise<string> {\r\n        const sql = `\r\n            INSERT INTO click_events (\r\n                search_event_id,\r\n                doc_id,\r\n                position\r\n            )\r\n            VALUES ($1, $2, $3)\r\n            RETURNING click_id\r\n        `;\r\n\r\n        try {\r\n            // Verify search_event_id exists to maintain referential integrity\r\n            // In a real high-volume system, we might skip this check or use a queue\r\n            if (event.search_event_id) {\r\n                const result = await pool.query(sql, [\r\n                    event.search_event_id,\r\n                    event.doc_id,\r\n                    event.position\r\n                ]);\r\n                return result.rows[0].click_id;\r\n            } else {\r\n                console.warn('Click event missing search_event_id, skipping insert');\r\n                return '';\r\n            }\r\n        } catch (error) {\r\n            console.error('Failed to log click event:', error);\r\n            return '';\r\n        }\r\n    }\r\n\r\n    async getUserHistory(userId: string, limit: number = 10) {\r\n        const sql = `\r\n            SELECT \r\n                se.query_text, \r\n                se.timestamp, \r\n                count(ce.click_id) as clicks\r\n            FROM search_events se\r\n            LEFT JOIN click_events ce ON se.event_id = ce.search_event_id\r\n            WHERE se.user_id = $1\r\n            GROUP BY se.event_id, se.query_text, se.timestamp\r\n            ORDER BY se.timestamp DESC\r\n            LIMIT $2\r\n        `;\r\n\r\n        try {\r\n            const result = await pool.query(sql, [userId, limit]);\r\n            return result.rows;\r\n        } catch (error) {\r\n            console.error('Failed to get user history:', error);\r\n            return [];\r\n        }\r\n    }\r\n}\r\n\r\nexport const interactionService = new InteractionService();\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAkBO,MAAM;IACT,MAAM,eAAe,KAAkB,EAAmB;QACtD,MAAM,MAAM,CAAC;;;;;;;;;;QAUb,CAAC;QAED,IAAI;YACA,MAAM,SAAS,MAAM,sHAAI,CAAC,KAAK,CAAC,KAAK;gBACjC,MAAM,OAAO,IAAI;gBACjB,MAAM,UAAU;gBAChB,MAAM,KAAK;gBACX,MAAM,YAAY;gBAClB,MAAM,iBAAiB;aAC1B;YACD,OAAO,OAAO,IAAI,CAAC,EAAE,CAAC,QAAQ;QAClC,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,OAAO,IAAI,kBAAkB;QACjC;IACJ;IAEA,MAAM,cAAc,KAAiB,EAAmB;QACpD,MAAM,MAAM,CAAC;;;;;;;;QAQb,CAAC;QAED,IAAI;YACA,kEAAkE;YAClE,wEAAwE;YACxE,IAAI,MAAM,eAAe,EAAE;gBACvB,MAAM,SAAS,MAAM,sHAAI,CAAC,KAAK,CAAC,KAAK;oBACjC,MAAM,eAAe;oBACrB,MAAM,MAAM;oBACZ,MAAM,QAAQ;iBACjB;gBACD,OAAO,OAAO,IAAI,CAAC,EAAE,CAAC,QAAQ;YAClC,OAAO;gBACH,QAAQ,IAAI,CAAC;gBACb,OAAO;YACX;QACJ,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,8BAA8B;YAC5C,OAAO;QACX;IACJ;IAEA,MAAM,eAAe,MAAc,EAAE,QAAgB,EAAE,EAAE;QACrD,MAAM,MAAM,CAAC;;;;;;;;;;;QAWb,CAAC;QAED,IAAI;YACA,MAAM,SAAS,MAAM,sHAAI,CAAC,KAAK,CAAC,KAAK;gBAAC;gBAAQ;aAAM;YACpD,OAAO,OAAO,IAAI;QACtB,EAAE,OAAO,OAAO;YACZ,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,OAAO,EAAE;QACb;IACJ;AACJ;AAEO,MAAM,qBAAqB,IAAI"}},
    {"offset": {"line": 182, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/lib/validation/schemas.ts"],"sourcesContent":["import { z } from 'zod';\r\n\r\n/**\r\n * Validation schemas for API request validation\r\n * Using Zod for type-safe runtime validation\r\n */\r\n\r\n// Search query validation\r\nexport const searchRequestSchema = z.object({\r\n  query: z\r\n    .string()\r\n    .trim()\r\n    .min(1, 'Query cannot be empty')\r\n    .max(500, 'Query too long (max 500 characters)')\r\n    .transform((val) => sanitizeQuery(val)),\r\n  page: z\r\n    .number()\r\n    .int()\r\n    .positive()\r\n    .max(100, 'Page number too high')\r\n    .default(1)\r\n    .optional(),\r\n  page_size: z\r\n    .number()\r\n    .int()\r\n    .positive()\r\n    .min(1)\r\n    .max(100, 'Page size too large')\r\n    .default(10)\r\n    .optional(),\r\n  filters: z\r\n    .object({\r\n      language: z.string().length(2).optional(),\r\n      site: z.string().url().or(z.string().regex(/^[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/)).or(z.array(z.string())).optional(),\r\n      dateRange: z\r\n        .object({\r\n          start: z.string().datetime().optional(),\r\n          end: z.string().datetime().optional(),\r\n        })\r\n        .optional(),\r\n    })\r\n    .optional(),\r\n  options: z\r\n    .object({\r\n      spell_correct: z.boolean().optional(),\r\n      exact_match: z.boolean().optional(),\r\n      safe_search: z.boolean().default(true).optional(),\r\n    })\r\n    .optional(),\r\n});\r\n\r\nexport type SearchRequest = z.infer<typeof searchRequestSchema>;\r\n\r\n// Suggestion query validation\r\nexport const suggestionRequestSchema = z.object({\r\n  q: z\r\n    .string()\r\n    .trim()\r\n    .min(1, 'Query must be at least 1 character')\r\n    .max(200, 'Query too long')\r\n    .transform((val) => sanitizeQuery(val)),\r\n  limit: z.number().int().positive().max(20).default(10).optional(),\r\n});\r\n\r\nexport type SuggestionRequest = z.infer<typeof suggestionRequestSchema>;\r\n\r\n// Click event validation\r\nexport const clickEventSchema = z.object({\r\n  search_event_id: z.string().uuid('Invalid search event ID'),\r\n  doc_id: z.string().uuid('Invalid document ID'),\r\n  position: z.number().int().positive().max(1000),\r\n  url: z.string().url('Invalid URL'),\r\n  query: z.string().max(500).optional(),\r\n});\r\n\r\nexport type ClickEvent = z.infer<typeof clickEventSchema>;\r\n\r\n// Admin crawl request validation\r\nexport const crawlRequestSchema = z.object({\r\n  urls: z\r\n    .array(z.string().url('Invalid URL'))\r\n    .min(1, 'At least one URL required')\r\n    .max(1000, 'Too many URLs (max 1000)'),\r\n  priority: z.enum(['low', 'normal', 'high']).default('normal').optional(),\r\n  respect_robots: z.boolean().default(true).optional(),\r\n});\r\n\r\nexport type CrawlRequest = z.infer<typeof crawlRequestSchema>;\r\n\r\n/**\r\n * Sanitizes search query to prevent injection attacks\r\n * Removes potentially dangerous characters while preserving search functionality\r\n */\r\nfunction sanitizeQuery(query: string): string {\r\n  // Remove null bytes\r\n  let sanitized = query.replace(/\\0/g, '');\r\n\r\n  // Remove control characters except newline, carriage return, tab\r\n  sanitized = sanitized.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, '');\r\n\r\n  // Limit consecutive spaces\r\n  sanitized = sanitized.replace(/\\s+/g, ' ');\r\n\r\n  // Remove leading/trailing whitespace\r\n  sanitized = sanitized.trim();\r\n\r\n  // Remove potentially dangerous SQL patterns (defense in depth)\r\n  const dangerousPatterns = [\r\n    /;\\s*(drop|delete|insert|update|create|alter|exec|execute|script)/gi,\r\n    /--/g,\r\n    /\\/\\*/g,\r\n    /\\*\\//g,\r\n  ];\r\n\r\n  for (const pattern of dangerousPatterns) {\r\n    sanitized = sanitized.replace(pattern, '');\r\n  }\r\n\r\n  return sanitized;\r\n}\r\n\r\n/**\r\n * Sanitizes HTML content to prevent XSS attacks\r\n * Strips all HTML tags and converts special characters\r\n */\r\nexport function sanitizeHtml(html: string): string {\r\n  if (!html) return '';\r\n\r\n  // Strip HTML tags\r\n  let sanitized = html.replace(/<[^>]*>/g, '');\r\n\r\n  // Encode special characters\r\n  sanitized = sanitized\r\n    .replace(/&/g, '&amp;')\r\n    .replace(/</g, '&lt;')\r\n    .replace(/>/g, '&gt;')\r\n    .replace(/\"/g, '&quot;')\r\n    .replace(/'/g, '&#x27;')\r\n    .replace(/\\//g, '&#x2F;');\r\n\r\n  return sanitized;\r\n}\r\n\r\n/**\r\n * Validates and sanitizes URLs\r\n */\r\nexport function sanitizeUrl(url: string): string {\r\n  try {\r\n    const parsed = new URL(url);\r\n\r\n    // Only allow http and https protocols\r\n    if (!['http:', 'https:'].includes(parsed.protocol)) {\r\n      throw new Error('Invalid protocol');\r\n    }\r\n\r\n    return parsed.toString();\r\n  } catch {\r\n    throw new Error('Invalid URL format');\r\n  }\r\n}\r\n\r\n/**\r\n * Rate limit check result\r\n */\r\nexport interface RateLimitCheck {\r\n  allowed: boolean;\r\n  remaining: number;\r\n  resetAt: Date;\r\n}\r\n\r\n/**\r\n * Error response structure\r\n */\r\nexport interface ErrorResponse {\r\n  error: {\r\n    code: string;\r\n    message: string;\r\n    details?: any;\r\n  };\r\n  request_id: string;\r\n  timestamp: string;\r\n}\r\n\r\n/**\r\n * Creates a standardized error response\r\n */\r\nexport function createErrorResponse(\r\n  code: string,\r\n  message: string,\r\n  details?: any,\r\n  requestId?: string\r\n): ErrorResponse {\r\n  return {\r\n    error: {\r\n      code,\r\n      message,\r\n      details,\r\n    },\r\n    request_id: requestId || `req_${Date.now()}_${Math.random().toString(36).substring(7)}`,\r\n    timestamp: new Date().toISOString(),\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 300, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/lib/middleware/rate-limit.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { createErrorResponse, RateLimitCheck } from '../validation/schemas';\r\n\r\n/**\r\n * Rate Limiting Middleware\r\n * Implements sliding window rate limiting with in-memory store\r\n * For production, integrate with Redis for distributed rate limiting\r\n */\r\n\r\ninterface RateLimitConfig {\r\n  windowMs: number; // Time window in milliseconds\r\n  maxRequests: number; // Maximum requests per window\r\n  keyGenerator?: (req: NextRequest) => string; // Custom key generator\r\n  skipSuccessfulRequests?: boolean; // Don't count successful requests\r\n  skipFailedRequests?: boolean; // Don't count failed requests\r\n}\r\n\r\ninterface RequestRecord {\r\n  timestamps: number[];\r\n  blockedUntil?: number;\r\n}\r\n\r\nclass RateLimiter {\r\n  private store: Map<string, RequestRecord> = new Map();\r\n  private cleanupInterval: NodeJS.Timeout;\r\n\r\n  constructor() {\r\n    // Cleanup old entries every 5 minutes\r\n    this.cleanupInterval = setInterval(() => {\r\n      this.cleanup();\r\n    }, 5 * 60 * 1000);\r\n  }\r\n\r\n  /**\r\n   * Check if request is allowed under rate limit\r\n   */\r\n  check(key: string, config: RateLimitConfig): RateLimitCheck {\r\n    const now = Date.now();\r\n    const windowStart = now - config.windowMs;\r\n\r\n    // Get or create record\r\n    let record = this.store.get(key);\r\n    if (!record) {\r\n      record = { timestamps: [] };\r\n      this.store.set(key, record);\r\n    }\r\n\r\n    // Check if currently blocked\r\n    if (record.blockedUntil && record.blockedUntil > now) {\r\n      return {\r\n        allowed: false,\r\n        remaining: 0,\r\n        resetAt: new Date(record.blockedUntil),\r\n      };\r\n    }\r\n\r\n    // Remove timestamps outside the window\r\n    record.timestamps = record.timestamps.filter((ts) => ts > windowStart);\r\n\r\n    // Check if limit exceeded\r\n    if (record.timestamps.length >= config.maxRequests) {\r\n      // Block for remaining window time\r\n      const oldestTimestamp = Math.min(...record.timestamps);\r\n      const resetAt = oldestTimestamp + config.windowMs;\r\n      record.blockedUntil = resetAt;\r\n\r\n      return {\r\n        allowed: false,\r\n        remaining: 0,\r\n        resetAt: new Date(resetAt),\r\n      };\r\n    }\r\n\r\n    // Add current request\r\n    record.timestamps.push(now);\r\n\r\n    return {\r\n      allowed: true,\r\n      remaining: config.maxRequests - record.timestamps.length,\r\n      resetAt: new Date(now + config.windowMs),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Cleanup old entries from store\r\n   */\r\n  private cleanup() {\r\n    const now = Date.now();\r\n    const maxAge = 3600000; // 1 hour\r\n\r\n    for (const [key, record] of this.store.entries()) {\r\n      // Remove if no recent activity and not blocked\r\n      if (\r\n        (!record.blockedUntil || record.blockedUntil < now) &&\r\n        record.timestamps.length === 0\r\n      ) {\r\n        this.store.delete(key);\r\n        continue;\r\n      }\r\n\r\n      // Remove if last activity was over max age\r\n      if (record.timestamps.length > 0) {\r\n        const lastTimestamp = Math.max(...record.timestamps);\r\n        if (now - lastTimestamp > maxAge) {\r\n          this.store.delete(key);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Reset rate limit for a key\r\n   */\r\n  reset(key: string) {\r\n    this.store.delete(key);\r\n  }\r\n\r\n  /**\r\n   * Shutdown cleanup interval\r\n   */\r\n  destroy() {\r\n    clearInterval(this.cleanupInterval);\r\n  }\r\n}\r\n\r\n// Global rate limiter instance\r\nconst rateLimiter = new RateLimiter();\r\n\r\n/**\r\n * Default rate limit configurations for different endpoints\r\n */\r\nexport const rateLimitConfigs = {\r\n  // Search API: 60 requests per minute per IP\r\n  search: {\r\n    windowMs: 60 * 1000,\r\n    maxRequests: 60,\r\n  },\r\n  // Suggestions API: 120 requests per minute per IP (more lenient for autocomplete)\r\n  suggest: {\r\n    windowMs: 60 * 1000,\r\n    maxRequests: 120,\r\n  },\r\n  // Admin APIs: 10 requests per minute per IP\r\n  admin: {\r\n    windowMs: 60 * 1000,\r\n    maxRequests: 10,\r\n  },\r\n  // Click tracking: 100 requests per minute per IP\r\n  click: {\r\n    windowMs: 60 * 1000,\r\n    maxRequests: 100,\r\n  },\r\n};\r\n\r\n/**\r\n * Get client identifier from request\r\n * Uses IP address, falling back to user-agent if IP unavailable\r\n */\r\nfunction getClientKey(req: NextRequest, prefix: string = 'rl'): string {\r\n  // Get IP address\r\n  const forwarded = req.headers.get('x-forwarded-for');\r\n  const realIp = req.headers.get('x-real-ip');\r\n  const ip = forwarded?.split(',')[0] || realIp || req.ip || 'unknown';\r\n\r\n  // Include user agent for better uniqueness\r\n  const userAgent = req.headers.get('user-agent') || 'unknown';\r\n  const userAgentHash = simpleHash(userAgent);\r\n\r\n  return `${prefix}:${ip}:${userAgentHash}`;\r\n}\r\n\r\n/**\r\n * Simple hash function for strings\r\n */\r\nfunction simpleHash(str: string): string {\r\n  let hash = 0;\r\n  for (let i = 0; i < str.length; i++) {\r\n    const char = str.charCodeAt(i);\r\n    hash = (hash << 5) - hash + char;\r\n    hash = hash & hash; // Convert to 32-bit integer\r\n  }\r\n  return Math.abs(hash).toString(36);\r\n}\r\n\r\n/**\r\n * Rate limit middleware factory\r\n * Creates middleware function with specified configuration\r\n */\r\nexport function createRateLimitMiddleware(config: RateLimitConfig) {\r\n  return async (req: NextRequest): Promise<NextResponse | null> => {\r\n    // Generate rate limit key\r\n    const key = config.keyGenerator?.(req) || getClientKey(req);\r\n\r\n    // Check rate limit\r\n    const result = rateLimiter.check(key, config);\r\n\r\n    // Add rate limit headers\r\n    const headers = new Headers();\r\n    headers.set('X-RateLimit-Limit', config.maxRequests.toString());\r\n    headers.set('X-RateLimit-Remaining', result.remaining.toString());\r\n    headers.set('X-RateLimit-Reset', result.resetAt.toISOString());\r\n\r\n    // If rate limit exceeded, return 429\r\n    if (!result.allowed) {\r\n      const retryAfter = Math.ceil((result.resetAt.getTime() - Date.now()) / 1000);\r\n      headers.set('Retry-After', retryAfter.toString());\r\n\r\n      return NextResponse.json(\r\n        createErrorResponse(\r\n          'RATE_LIMIT_EXCEEDED',\r\n          'Too many requests. Please try again later.',\r\n          {\r\n            limit: config.maxRequests,\r\n            window_ms: config.windowMs,\r\n            retry_after_seconds: retryAfter,\r\n          }\r\n        ),\r\n        {\r\n          status: 429,\r\n          headers,\r\n        }\r\n      );\r\n    }\r\n\r\n    return null; // Allow request to proceed\r\n  };\r\n}\r\n\r\n/**\r\n * Apply rate limiting to a handler function\r\n */\r\nexport function withRateLimit(\r\n  handler: (req: NextRequest) => Promise<NextResponse>,\r\n  config: RateLimitConfig\r\n) {\r\n  return async (req: NextRequest): Promise<NextResponse> => {\r\n    const rateLimitMiddleware = createRateLimitMiddleware(config);\r\n    const rateLimitResponse = await rateLimitMiddleware(req);\r\n\r\n    if (rateLimitResponse) {\r\n      return rateLimitResponse;\r\n    }\r\n\r\n    return handler(req);\r\n  };\r\n}\r\n\r\n/**\r\n * Session-based rate limiting (in addition to IP-based)\r\n * More lenient limits for authenticated users\r\n */\r\nexport function getSessionKey(req: NextRequest): string {\r\n  const sessionId = req.headers.get('x-session-id');\r\n  const userId = req.headers.get('x-user-id');\r\n\r\n  if (userId) {\r\n    return `rl:user:${userId}`;\r\n  } else if (sessionId) {\r\n    return `rl:session:${sessionId}`;\r\n  } else {\r\n    return getClientKey(req);\r\n  }\r\n}\r\n\r\n/**\r\n * Export rate limiter for testing\r\n */\r\nexport { rateLimiter };\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 500, "column": 0}, "map": {"version":3,"sources":["file:///D:/search-engine-spec/app/api/v1/click/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { interactionService } from '@/lib/services/interaction-service';\r\nimport { clickEventSchema, createErrorResponse } from '@/lib/validation/schemas';\r\nimport { withRateLimit, rateLimitConfigs } from '@/lib/middleware/rate-limit';\r\n\r\n/**\r\n * Click Tracking API endpoint\r\n * POST /api/v1/click\r\n * \r\n * Features:\r\n * - Input validation\r\n * - Rate limiting (100 req/min per IP)\r\n * - Async logging (fire and forget)\r\n */\r\n\r\nasync function clickHandler(req: NextRequest) {\r\n    const requestId = `req_${Date.now()}_${Math.random().toString(36).substring(7)}`;\r\n\r\n    try {\r\n        const body = await req.json();\r\n        \r\n        // Validate request body\r\n        const validation = clickEventSchema.safeParse(body);\r\n        if (!validation.success) {\r\n            return NextResponse.json(\r\n                createErrorResponse(\r\n                    'VALIDATION_ERROR',\r\n                    'Invalid click event data',\r\n                    validation.error.errors,\r\n                    requestId\r\n                ),\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        const { search_event_id, doc_id, position, url } = validation.data;\r\n        const sessionId = req.headers.get('x-session-id') || 'anonymous';\r\n        const userId = req.headers.get('x-user-id') || undefined;\r\n\r\n        // Log click event asynchronously (don't block response)\r\n        interactionService.logClickEvent({\r\n            search_event_id,\r\n            doc_id,\r\n            position,\r\n            session_id: sessionId,\r\n            user_id: userId,\r\n        }).catch((error) => {\r\n            console.error('Failed to log click event:', error);\r\n        });\r\n\r\n        // Return success immediately\r\n        return NextResponse.json({\r\n            success: true,\r\n            request_id: requestId,\r\n        });\r\n    } catch (error: any) {\r\n        console.error('Click API error:', error);\r\n        return NextResponse.json(\r\n            createErrorResponse(\r\n                'INTERNAL_ERROR',\r\n                'Failed to process click event',\r\n                process.env.NODE_ENV === 'development' ? error.message : undefined,\r\n                requestId\r\n            ),\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n\r\n// Export with rate limiting\r\nexport const POST = withRateLimit(clickHandler, rateLimitConfigs.click);\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEA;;;;;;;;CAQC,GAED,eAAe,aAAa,GAAgB;IACxC,MAAM,YAAY,CAAC,IAAI,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,IAAI;IAEhF,IAAI;QACA,MAAM,OAAO,MAAM,IAAI,IAAI;QAE3B,wBAAwB;QACxB,MAAM,aAAa,kJAAgB,CAAC,SAAS,CAAC;QAC9C,IAAI,CAAC,WAAW,OAAO,EAAE;YACrB,OAAO,gJAAY,CAAC,IAAI,CACpB,IAAA,qJAAmB,EACf,oBACA,4BACA,WAAW,KAAK,CAAC,MAAM,EACvB,YAEJ;gBAAE,QAAQ;YAAI;QAEtB;QAEA,MAAM,EAAE,eAAe,EAAE,MAAM,EAAE,QAAQ,EAAE,GAAG,EAAE,GAAG,WAAW,IAAI;QAClE,MAAM,YAAY,IAAI,OAAO,CAAC,GAAG,CAAC,mBAAmB;QACrD,MAAM,SAAS,IAAI,OAAO,CAAC,GAAG,CAAC,gBAAgB;QAE/C,wDAAwD;QACxD,iKAAkB,CAAC,aAAa,CAAC;YAC7B;YACA;YACA;YACA,YAAY;YACZ,SAAS;QACb,GAAG,KAAK,CAAC,CAAC;YACN,QAAQ,KAAK,CAAC,8BAA8B;QAChD;QAEA,6BAA6B;QAC7B,OAAO,gJAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT,YAAY;QAChB;IACJ,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,gJAAY,CAAC,IAAI,CACpB,IAAA,qJAAmB,EACf,kBACA,iCACA,uCAAyC,MAAM,OAAO,GAAG,yBACzD,YAEJ;YAAE,QAAQ;QAAI;IAEtB;AACJ;AAGO,MAAM,OAAO,IAAA,qJAAa,EAAC,cAAc,wJAAgB,CAAC,KAAK"}}]
}